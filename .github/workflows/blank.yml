name: Jaime-DataCollection

permissions:
  id-token: write
  contents: read

on:
  workflow_dispatch:
    inputs:
      dry-run:
        description: "Enable dry-run mode"
        type: boolean
        default: false
      environment:
        description: "Environment for dry-run"
        type: choice
        options: 
          - development
          - staging
          - production

  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"
    branches:
      - main
      - develop/**
      - release/**
      - hotfixes/**
    paths:
      - functions/**
      - step-function-workflow/**

env:
  # FINAL ENV LOGIC (same as your CI)
  IS_DEV: ${{ (inputs.dry-run && inputs.environment == 'development')
      || (!inputs.dry-run && startsWith(github.ref, 'refs/heads/develop/')) }}

  IS_STAGING: ${{ (inputs.dry-run && inputs.environment == 'staging')
      || (!inputs.dry-run && startsWith(github.ref, 'refs/heads/release/'))
      || (!inputs.dry-run && startsWith(github.ref, 'refs/heads/hotfixes/')) }}

  IS_PROD: ${{ (inputs.dry-run && inputs.environment == 'production')
      || (!inputs.dry-run && github.ref_type == 'tag') }}

jobs:
  #########################################################################
  # 1) DETECT ENVIRONMENT + CHANGED ITEMS
  #########################################################################
  detect_changes:
    name: Detect Environment + Changed Components
    runs-on: ubuntu-latest

    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      functions: ${{ steps.filter.outputs.functions }}
      workflows: ${{ steps.filter.outputs.workflows }}

    steps:
      - uses: actions/checkout@v4

      #################################################################
      # Determine ENV
      #################################################################
      - id: set-env
        name: Determine Environment
        run: |
          if [ "${{ env.IS_DEV }}" = "true" ]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
          elif [ "${{ env.IS_STAGING }}" = "true" ]; then
            echo "environment=stg" >> $GITHUB_OUTPUT
          elif [ "${{ env.IS_PROD }}" = "true" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "::error::Unable to determine environment"
            exit 1
          fi

      #################################################################
      # Detect changed files
      #################################################################
      - id: changes
        uses: tj-actions/changed-files@v46.0.1
        with:
          dir_names: true
          files: |
            functions/**
            step-function-workflow/**

      #################################################################
      # Filter Components (NO ERRORS)
      #################################################################
      - id: filter
        name: Filter Changed Components
        run: |
          RAW="${{ steps.changes.outputs.all_changed_files }}"
          ENV="${{ steps.set-env.outputs.environment }}"

          echo "RAW input: $RAW"

          # Convert RAW → valid JSON array
          if [[ "$RAW" == "["* ]]; then
            FILES="$RAW"
          elif [[ -z "$RAW" ]]; then
            FILES="[]"
          else
            FILES="[\"$RAW\"]"
          fi

          echo "FILES (normalized JSON): $FILES"

          # Use lowercase startswith() — jq builtin
          FUNCTIONS=$(echo "$FILES" | jq '[.[] | select(startswith("functions/"))]')
          WORKFLOWS=$(echo "$FILES" | jq "[.[] | select(startswith(\"step-function-workflow/${ENV}\"))]")

            SAFE_FUNCTIONS=$(echo "$FUNCTIONS" | jq -c .)
            SAFE_WORKFLOWS=$(echo "$WORKFLOWS" | jq -c .)
            
            echo "functions=$SAFE_FUNCTIONS" >> $GITHUB_OUTPUT
            echo "workflows=$SAFE_WORKFLOWS" >> $GITHUB_OUTPUT



  #########################################################################
  # 2) DEPLOY ONLY CHANGED ITEMS
  #########################################################################
  deploy:
    name: Deploy Only Changed Items
    needs: detect_changes
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Print Detected Info
        run: |
          echo "Environment:     ${{ needs.detect_changes.outputs.environment }}"
          echo "Changed Functions: ${{ needs.detect_changes.outputs.functions }}"
          echo "Changed Workflows: ${{ needs.detect_changes.outputs.workflows }}"

      #################################################################
      # Deploy Lambdas
      #################################################################
      - name: Deploy Lambdas
        if: ${{ needs.detect_changes.outputs.functions != '[]' }}
        run: |
          echo "FUNCTIONS JSON:"
          echo '${{ needs.detect_changes.outputs.functions }}'

          echo '${{ needs.detect_changes.outputs.functions }}' \
            | jq -r '.[]' \
            | while read f; do

              echo "Processing Lambda: $f"

              ROOT=$(echo "$f" | awk -F/ '{print $1"/"$2}')
              echo "➡ Deploying Lambda: $ROOT"

              bash ./scripts/deploy_lambda.sh "$ROOT" "${{ needs.detect_changes.outputs.environment }}"
            done

      #################################################################
      # Deploy Step Functions
      #################################################################
      - name: Deploy Step Functions
        if: ${{ needs.detect_changes.outputs.workflows != '[]' }}
        run: |
          echo "WORKFLOWS JSON:"
          echo '${{ needs.detect_changes.outputs.workflows }}'

          echo '${{ needs.detect_changes.outputs.workflows }}' \
            | jq -r '.[]' \
            | while read w; do

              echo "➡ Deploying Step Function: $w"

              bash ./scripts/deploy_step_function.sh "$w" "${{ needs.detect_changes.outputs.environment }}"
            done
